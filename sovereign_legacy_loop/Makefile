# ðŸŒ SHADOW.AI II - UNIFIED EMPIRE
# Makefile for streamlined container management
# Owner: LEDGERGHOST90

.PHONY: help build up down restart logs clean dev prod staging

# Default target
help: ## Show this help message
	@echo "ðŸŒ SHADOW.AI II - Unified Empire Management"
	@echo "=========================================="
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Environment setup
dev: ## Start development environment
	@echo "ðŸš€ Starting Development Environment..."
	@cp environments/development.env .env
	@docker-compose -f docker-compose.yml --env-file .env up -d
	@echo "âœ… Development environment started"
	@echo "ðŸ“Š Dashboard: http://localhost:3000"
	@echo "ðŸ¤– MCP Server: http://localhost:8000"
	@echo "ðŸ“ˆ Grafana: http://localhost:3001"

staging: ## Start staging environment
	@echo "ðŸ§ª Starting Staging Environment..."
	@cp environments/staging.env .env
	@docker-compose -f docker-compose.yml --env-file .env up -d
	@echo "âœ… Staging environment started"

prod: ## Start production environment
	@echo "ðŸ­ Starting Production Environment..."
	@cp environments/production.env .env
	@docker-compose -f docker-compose.yml --env-file .env up -d
	@echo "âœ… Production environment started"

# Build operations
build: ## Build all services
	@echo "ðŸ”¨ Building all services..."
	@docker-compose build --parallel
	@echo "âœ… Build completed"

build-no-cache: ## Build all services without cache
	@echo "ðŸ”¨ Building all services (no cache)..."
	@docker-compose build --no-cache --parallel
	@echo "âœ… Build completed"

# Container operations
up: ## Start all services
	@echo "ðŸš€ Starting all services..."
	@docker-compose up -d
	@echo "âœ… All services started"

down: ## Stop all services
	@echo "ðŸ›‘ Stopping all services..."
	@docker-compose down
	@echo "âœ… All services stopped"

restart: ## Restart all services
	@echo "ðŸ”„ Restarting all services..."
	@docker-compose restart
	@echo "âœ… All services restarted"

# Monitoring
logs: ## Show logs for all services
	@docker-compose logs -f

logs-gateway: ## Show API gateway logs
	@docker-compose logs -f api-gateway

logs-dashboard: ## Show dashboard logs
	@docker-compose logs -f dashboard

logs-mcp: ## Show MCP server logs
	@docker-compose logs -f mcp-server

logs-exchange: ## Show exchange connector logs
	@docker-compose logs -f exchange-connector

# Health checks
health: ## Check health of all services
	@echo "ðŸ¥ Health Check Report"
	@echo "====================="
	@docker-compose ps
	@echo ""
	@echo "ðŸ” Service Health:"
	@curl -s http://localhost/health || echo "âŒ Gateway not responding"
	@curl -s http://localhost:3000/api/health || echo "âŒ Dashboard not responding"
	@curl -s http://localhost:8000/health || echo "âŒ MCP Server not responding"

status: ## Show status of all services
	@docker-compose ps

# Database operations
db-migrate: ## Run database migrations
	@echo "ðŸ—„ï¸ Running database migrations..."
	@docker-compose exec dashboard npx prisma migrate deploy
	@echo "âœ… Migrations completed"

db-reset: ## Reset database
	@echo "ðŸ—„ï¸ Resetting database..."
	@docker-compose exec dashboard npx prisma migrate reset --force
	@echo "âœ… Database reset completed"

db-seed: ## Seed database with initial data
	@echo "ðŸŒ± Seeding database..."
	@docker-compose exec dashboard npx prisma db seed
	@echo "âœ… Database seeded"

# Cleanup operations
clean: ## Clean up containers, networks, and volumes
	@echo "ðŸ§¹ Cleaning up..."
	@docker-compose down -v --remove-orphans
	@docker system prune -f
	@echo "âœ… Cleanup completed"

clean-all: ## Clean up everything including images
	@echo "ðŸ§¹ Deep cleaning..."
	@docker-compose down -v --remove-orphans
	@docker system prune -af
	@echo "âœ… Deep cleanup completed"

# Security
security-scan: ## Run security scan on images
	@echo "ðŸ”’ Running security scan..."
	@docker-compose config
	@echo "âœ… Configuration validated"

# Backup operations
backup: ## Backup database and volumes
	@echo "ðŸ’¾ Creating backup..."
	@mkdir -p ./backups/$(shell date +%Y%m%d_%H%M%S)
	@docker-compose exec postgres pg_dump -U trader shadow_ai > ./backups/$(shell date +%Y%m%d_%H%M%S)/database.sql
	@docker run --rm -v shadow-ai_postgres-data:/data -v $(PWD)/backups/$(shell date +%Y%m%d_%H%M%S):/backup alpine tar czf /backup/postgres-data.tar.gz -C /data .
	@echo "âœ… Backup completed"

# Development tools
shell-dashboard: ## Open shell in dashboard container
	@docker-compose exec dashboard /bin/sh

shell-mcp: ## Open shell in MCP server container
	@docker-compose exec mcp-server /bin/bash

shell-db: ## Open PostgreSQL shell
	@docker-compose exec postgres psql -U trader -d shadow_ai

# Monitoring access
grafana: ## Open Grafana dashboard
	@echo "ðŸ“Š Opening Grafana..."
	@open http://localhost:3001

prometheus: ## Open Prometheus dashboard
	@echo "ðŸ“ˆ Opening Prometheus..."
	@open http://localhost:9090

# Quick start
quickstart: ## Quick start for new users
	@echo "ðŸš€ Shadow.AI II Quick Start"
	@echo "=========================="
	@echo "1. Setting up development environment..."
	@make dev
	@echo ""
	@echo "2. Waiting for services to be ready..."
	@sleep 30
	@echo ""
	@echo "3. Checking health..."
	@make health
	@echo ""
	@echo "âœ… Quick start completed!"
	@echo "ðŸ“Š Dashboard: http://localhost:3000"
	@echo "ðŸ¤– MCP Server: http://localhost:8000"
	@echo "ðŸ“ˆ Grafana: http://localhost:3001"